---
title: "${}^{18}$O exchange between water reservoirs"
subtitle: "Exercises Accompanying the Course Reaction Transport Modelling in the Hydrosphere"
author: "Lubos Polerecky, Utrecht University"
date: "February 2022"
output: pdf_document
header-includes: 
  \usepackage{float} 
  \floatplacement{figure}{th}
  \usepackage{siunitx}
---

# Task 1 --- solution

First, we define model parameters and empirical constants.

```{r}
# model parameters
Aliq     <- 1           # liquid water area (m2) 
Ptot     <- 101325      # total pressure (Pa)
v        <- 0           # wind speed (m h-1)
TK       <- 298         # temperature (K)
xini     <- 0.002       # initial 18O atom fraction of liquid water

# empirical constants or parameters
Rgas     <- 8.314       # gas constant (J mol-1 K-1)
dHvap    <- 40.66e3     # molar enthalpy of vaporization of 16O-water (J mol-1)
Pstd     <- 101325      # standard pressure (1 atm, in Pa)
Tboil    <- 373.15      # boiling point of water at standard pressure (K)
rho      <- 1e3         # water density (kg m-3)
MW       <- 18e-3       # molar weight of water (kg mol-1)
                        # rho/MW is assumed to be the same for 16O-H2O and 18O-H2O!
```

Second, we define auxiliary functions for calculating the equilibrium vapor pressure and amounts of water molecules in the gas and liquid phase from temperature, volume, and air humidity.

```{r}
Peq_vapor <- function(TK=300)                  # input temperature in K!
  Pstd * exp( -dHvap/Rgas * (1/TK - 1/Tboil) ) # Clausius-Clapeyron equation

Nwater_vapor <- function(humid, TK, V){ # calculate Nvap from humidity, T, and volume
  humid*Peq_vapor(TK)*V/(TK*Rgas)       # based on the ideal gas law
}

Nwater_liquid <- function(V){           # calculate Nliq from volume
  rho*V/MW                              # using density and molar weight
}
```

Third, we define a function for calculating state variables based on the initial conditions specified by the problem.

```{r}
find_state <- function(Vtot, Vliq, humid, TK, Ptot, x18vap, x18liq){
  Vgas <- Vtot - Vliq  # volume of the gas phase = Vtotal - Vliquid

  # total amounts of vapor, liquid, and air in the gas phase:
  Nvap <- Nwater_vapor(humid=humid, TK=TK, V=Vgas)
  Nliq <- Nwater_liquid(V=Vliq)
  Nair <- Ptot * Vgas/(Rgas*TK) - Nvap
  
  # output: state variables and parameters
  return( c(N18vap = Nvap*x18vap, N16vap = Nvap*(1-x18vap),
            N18liq = Nliq*x18liq, N16liq = Nliq*(1-x18liq),
            Nair   = Nair) ) # not changing but required
}
```

Fourth, we implement the calculation of rate constants as described in the section "Rate constants" (see above).

```{r}
kfbT <- function(TK, v=0, delta18O){    # rate constants
  alpha <- 1/(delta18O*1e-3 + 1)        # convert delta18O (in permil!) to alpha
  # enthalpy of vaporization of water
  dH16vap <- dHvap                                           # 16O-water, given above
  dH18vap <- dH16vap + Rgas*TK*Tboil/(Tboil-TK) * log(alpha) # 18O-water
  # empirical constants (Carrier, 1918), assumed equal for 16O and 18O-water!
  c1      <- 0.0888*3600 # (m h-1)
  c2      <- 0.0783      # (-)
  # rate constants for water precipitation (m h-1)
  kb16 <- Rgas*TK/dH16vap*(c1+c2*v)                          # 16O-water
  kb18 <- Rgas*TK/dH18vap*(c1+c2*v)                          # 18O-water
  # rate constants for water evaporation (mol m-2 h-1)
  kf16 <- kb16 * Peq_vapor(TK)/(Rgas*TK)                     # 16O-water
  kf18 <- kb18 * Peq_vapor(TK)/alpha/(Rgas*TK)               # 18O-water
  return(c(kb16=kb16, kb18=kb18, kf16=kf16, kf18=kf18))
}
```

Finally, we implement the model function based on the differential equations 8 and 9. 

```{r, eval = TRUE, cache = FALSE, echo = TRUE, warning=FALSE, message=FALSE}
Water18Oexchange <-function(t, state, pars) {
  with (as.list(c(state, pars)),{
    
    # total amounts of vapor and liquid (mol)
    Nvap <- N18vap + N16vap
    Nliq <- N18liq + N16liq
    
    # 18O atom fractions
    x18vap           <- N18vap/Nvap
    x18liq           <- N18liq/Nliq
    
    # volume of the gas phase (air+vapor) at a given Nvap, Nair, TK, and Ptot
    Vgas <- Rgas*TK*(Nair+Nvap)/Ptot # based on the ideal gas law
    
    # process rates, mol h-1 (rate constants in pars!)
    evap16 <- kf16*Aliq * (1-x18liq) * (Nliq/(Nliq+1e-6))
    evap18 <- kf18*Aliq *    x18liq  * (Nliq/(Nliq+1e-6))
    prec16 <- kb16*Aliq * (1-x18vap) * Nvap/Vgas
    prec18 <- kb18*Aliq *    x18vap  * Nvap/Vgas
    
    # time-derivatives
    dN18vap.dt <-  evap18 - prec18
    dN16vap.dt <-  evap16 - prec16
    dN18liq.dt <- -evap18 + prec18
    dN16liq.dt <- -evap16 + prec16
    dNair.dt   <- 0 # no gas dissolution in water!
    
    # extra output
    Pvap <- Nvap/Vgas * Rgas * TK  # partial pressure of water vapor
    Pair <- Nair/Vgas * Rgas * TK  # partial pressure of air
    
    # return time-derivatives and ordinary variables as a list
    list(c(dN18vap.dt, dN16vap.dt, dN18liq.dt, dN16liq.dt, dNair.dt),
         
         # extra output quantities:
         Nwater = Nvap + Nliq,       # total amount of water (vapor+liquid)
         
         # volumes (m3)
         Vgas = Vgas,                # gas phase
         Vliq = Nliq*MW/rho,         # liquid phase
         Vtot = Vgas+Nliq*MW/rho,    # total (gas+liquid)
         
         # pressures (Pa) and relative humidity
         Pvap = Pvap,                # water vapor (16O+18O-water!)
         Pair = Pair,                # air
         Pgas = Pvap+Pair,           # total gas pressure (vapor+air)
         humid = Pvap/Peq_vapor(TK), # relative humidity (16O+18O-water!)
         
         # 18O atom fractions and delta vapor vs. liquid
         x18vap = x18vap,
         x18liq = x18liq,
         delta_Vap_vs_Liq = ((N18vap/N16vap)/(N18liq/N16liq)-1)*1e3 # permil
      )
  })
}
```

## Model application

We solve the model for two initial values of the relative air humidity: 0 (scenario 1) and 1 (scenario 2). 

First, we use the above functions to calculate the rate constants and set the initial values of the state variables based on the definition of the problem. Note that in scenario 1, we use a very small initial humidity instead of 0 to avoid problems with division by zero. Additionally, as there is initially no precipitation in this scenario (because $N_{vap,ini}=0$), equations 8 and 9 imply that the amount of water vapor increases in time according to ${}^{18}N_{vap}={}^{18}k_f\cdot x_{liq,ini}\cdot A_{liq}\cdot t$ and ${}^{16}N_{vap}={}^{16}k_f\cdot (1-x_{liq,ini})\cdot A_{liq}\cdot t$ when $t$ is very small. These expressions imply that $x_{vap}$ increases from the initial value of 
$$
x_{vap,ini} = \frac{{}^{18}k_f\cdot x_{liq,ini}}{{}^{18}k_f\cdot x_{liq,ini}+{}^{16}k_f\cdot (1-x_{liq,ini})}.
$$
Thus, for scenario 1, we set ``x18vap`` to this value when calculating the initial values of the state variables.

```{r, message=FALSE}
# rate constants (used as model parameters)
k <- kfbT(TK=TK, delta18O=-10)

# initial conditions, scenario 1 (see note above)
xvap.ini <- k[["kf18"]]*xini / ( k[["kf18"]]*xini + k[["kf16"]]*(1-xini) )
SVini1 <- find_state(Vtot=1, Vliq=1e-3, TK=TK, Ptot=Ptot, x18liq=xini,
                     humid=1e-6, x18vap=xvap.ini)
# initial conditions, scenario 2
SVini2 <- find_state(Vtot=1, Vliq=1e-3, TK=TK, Ptot=Ptot, x18liq=xini,
                     humid=1,    x18vap=xini)

# solve the model
require(deSolve)
outtimes <- seq(from = 0, to = 0.5, length.out = 400) # time in hr
out1 <- ode(y = SVini1, parms = k, func = Water18Oexchange, times = outtimes)
out2 <- ode(y = SVini2, parms = k, func = Water18Oexchange, times = outtimes)
```

## Results & Discussion

First, we plot the amounts of molecules to validate the mass balances. The results below show that the total amounts of water and air remain constant, as required. The total amount of water is slightly greater for scenario 2, since the air is initially humid and the initial volume of the liquid is the same as in scenario 1. Because the total volume is the same, the amount of air follows the opposite pattern (more water vapor implies less air for the given volume, pressure and temperature of the gas phase). 

```{r, fig.height=5, fig.width=8}
plot(out1, out2, 
     which=c("N18vap", "N16vap", "Nair", "N18liq", "N16liq", "Nwater"),
     xlab="time (hr)", lty=1, las=1, lwd=2, mfrow=c(2,3), ylab="mol")
legend("right", title="initial air humidity:", legend=c("0","1"), 
       lty=1, lwd=2, col=1:2, bty="n")
```

Next, we plot volumes (see graphs below). In scenario 1, the volume of the gas phase and the total volume increase, whereas the liquid water decreases, due to the net water evaporation occurring at a constant total pressure and temperature. There is no volume change in scenario 2 because the air is initially fully saturated with water vapor, thus there is no net transfer of water from the liquid to the gas phase. 

```{r, fig.height=2.5, fig.width=8}
plot(out1, out2, 
     which=c("Vgas", "Vliq", "Vtot"),
     xlab="time (hr)", lty=1, las=1, lwd=2, mfrow=c(1,3), ylab="m3")
legend("right", title="initial air humidity:", legend=c("0","1"), 
       lty=1, lwd=2, col=1:2, bty="n")
```

Next, we plot pressures and the relative air humidity to verify that the results make sense. In scenario 1, the partial pressure of water vapor increases, the partial pressure of air decreases, and the total gas pressure remains constant as required. The relative air humidity increases from 0 to 1, as required, and the equilibrium is reached in about 15 minutes. In scenario 2, there are no changes in the pressures or relative air humidity, as the initial condition corresponds to the equilibrium for the total amount of water vapor in the gas phase.

```{r, fig.height=2.5, fig.width=8}
plot(out1, out2, 
     which=c("Pvap", "Pair", "Pgas", "humid"),
     xlab="time (hr)", lty=1, las=1, lwd=2, mfrow=c(1,4), 
     ylab=c(rep("Pa",3),"-"))
legend("right", title="initial air humidity:", legend=c("0","1"), 
       lty=1, lwd=2, col=1:2, bty="n")
```

Finally, we plot the ${}^{18}O$ atom fractions of the water vapor and liquid water along with the relative difference in the isotopic composition of water vapor versus liquid water ($\delta_{liq}(vap)$). In both scenarios, water vapor becomes depleted in ${}^{18}O$, and the equilibrium value of $\delta^*_{liq}(vap)$ is equal to $-10$ \textperthousand, as required. How this value is approached depends, however, on the initial condition: the equilibrium is approached from below and from above if the air is initially dry and fully saturated with water vapor, respectively. 

```{r, fig.height=2.5, fig.width=8}
plot(out1, out2, 
     which=c("x18vap", "x18liq", "delta_Vap_vs_Liq"),
     xlab="time (hr)", lty=1, las=1, lwd=2, mfrow=c(1,3), ylab="-")
legend("right", title="initial air humidity:", legend=c("0","1"), 
       lty=1, lwd=2, col=1:2, bty="n")
```












# Task 2 --- solution

## Parameters describing the experimental setup

```{r}
V3    <- 1      # air volume (m3)
P     <- 101325 # air pressure (Pa)
Rgas  <- 8.314  # gas constant (SI units)
TK    <- 293.15 # temperature (K)
fH2O  <- 0.01   # molar fraction of water in air at 100% humidity
kb    <- 10     # rate constant of water precipitation (m d-1)
A1    <- 1      # area of the water reservoir 1 (m2) 
                # (corresponds to 3*4 subcores, each with inner diameter 1.2 cm)
A2    <- 1      # area of the water reservoir 2 (m2)
                # square of 25x25 cm
h1    <- 1e-3   # height of the water reservoir 1 (m)
h2    <- 1e-3   # height of the water reservoir 2 (m)
xini  <- 0.002  # natural 18O atom fraction
x1ini <- 0.002  # initial 18O atom fraction in water reservoir 1
x2ini <- 0.002  # initial 18O atom fraction in water reservoir 2
x3ini <- 0.002  # initial 18O atom fraction of water vapor (=water reservoir 3)
rho   <- 1e3    # water density (kg m-3)
MW    <- 18e-3  # molar weight of water (kg mol-1)
                # rho/MW is assumed to be the same for 16O-H2O and 18O-H2O!
```

## Derived parameters

```{r}
c3eq  <- P/(Rgas*TK) * fH2O # density of H2O molecules in air at 100% humidity (mol/m3)
V1    <- A1*h1              # volume of water in reservoir 1 (m3)
V2    <- A2*h2              # volume of water in reservoir 2 (m3)
# note: the density of particles (N/V=rho/MW) is assumed to be the same for 16O-H2O and 18O-H2O!
N1ini <- rho*V1/MW          # initial amount of H2O molecules in reservoir 1 (mol)
N2ini <- rho*V2/MW          # initial amount of H2O molecules in reservoir 2 (mol)
N3eq  <- c3eq*V3            # equilibrium amount of H2O molecules in reservoir 3 (mol)
```

## Model parameters
```{r}
pars <- c(delta = 0, # delta = steady state (R3/R1-1)*1e3, in permil!
          f1    = 1, # consider reservoir 1
          f2    = 0  # consider reservoir 2
          )
```

## Initial conditions

```{r}
# function to calculate initial state based on initial humidity of the air
humidityH2Oini <- function(humidity=1){
  # all values are in moles (16O-H2O and 18O-H2O isotopes separately)
  H2Oini <- c(N1_16 = N1ini*(1-x1ini),
              N1_18 = N1ini*x1ini,
              N2_16 = N2ini*(1-x2ini),
              N2_18 = N2ini*x2ini,
              N3_16 = N3eq*(1-x3ini) * humidity,
              N3_18 = N3eq*x3ini     * humidity
             )
  return(H2Oini)
}
```

# Model definition

```{r, eval = TRUE, cache = FALSE, echo = TRUE, warning=FALSE, message=FALSE}
WaterExchangeModel <-function(t, state, pars) {
  # t: time, state: state variables, pars: model parameters
  with (as.list(c(state, pars)),{
    
    # convert delta (in permil!) to alpha = kb_18/kb_16
    alpha <- 1/(delta*1e-3 + 1)
    
    # calculate all rate constants based on the rate constant 
    # of water precipitation (kb), the fractionation factor (alpha), 
    # and the equilibrium concentration c3eq
    kb_16 <- kb
    kb_18 <- kb * alpha
    kf_16 <- kb * c3eq
    kf_18 <- kb * c3eq
          
    # current amounts of H2O molecules in all reservoirs
    N1 <- N1_16+N1_18 
    N2 <- N2_16+N2_18 
    N3 <- N3_16+N3_18
    # current 18O atom fractions in all reservoirs
    x1 <- N1_18/N1 
    x2 <- N2_18/N2
    x3 <- N3_18/N3
    
    # rate expressions [mol/d]
    
    # exchange between reservoir 1 (water) and 3 (water vapour)
    Evap1_16 <- kf_16 * (1-x1) * A1 * (N1>0)
    Evap1_18 <- kf_18 *    x1  * A1 * (N1>0)
    Cond1_16 <- kb_16 * (1-x3) * A1 * N3/V3
    Cond1_18 <- kb_18 *    x3  * A1 * N3/V3
    
    # exchange between reservoir 2 (water) and 3 (water vapour)
    Evap2_16 <- kf_16 * (1-x2) * A2 * (N2>0)
    Evap2_18 <- kf_18 *    x2  * A2 * (N2>0)
    Cond2_16 <- kb_16 * (1-x3) * A2 * N3/V3
    Cond2_18 <- kb_18 *    x3  * A2 * N3/V3
    
    # Time-derivatives: dN/dt = production - consumption [mol/d]
    dN1_16.dt <- (-Evap1_16 + Cond1_16)*f1
    dN1_18.dt <- (-Evap1_18 + Cond1_18)*f1
    dN2_16.dt <- (-Evap2_16 + Cond2_16)*f2
    dN2_18.dt <- (-Evap2_18 + Cond2_18)*f2
    dN3_16.dt <- ( Evap1_16 - Cond1_16)*f1 + (Evap2_16 - Cond2_16)*f2
    dN3_18.dt <- ( Evap1_18 - Cond1_18)*f1 + (Evap2_18 - Cond2_18)*f2
    
    # return time-derivatives and ordinary variables as a list
    list(c(dN1_16.dt, dN1_18.dt,
           dN2_16.dt, dN2_18.dt,
           dN3_16.dt, dN3_18.dt),
         
         # number of molecules
         Ntot_16 = N1_16+N2_16+N3_16, # total 16O-water
         Ntot_18 = N1_18+N2_18+N3_18, # total 18O-water
         N1 = N1_16 + N1_18,          # total water molecules, liquid 1
         N2 = N2_16 + N2_18,          # total water molecules, liquid 2
         N3 = N3_16 + N3_18,          # total water molecules, vapor
         Ntot = N1_16+N2_16+N3_16+N1_18+N2_18+N3_18, # all water molecules
         
         # 18O atom fractions
         x1 = N1_18/(N1_16+N1_18),
         x2 = N2_18/(N2_16+N2_18),
         x3 = N3_18/(N3_16+N3_18),
         
         # delta values (permil): delta_a_vs_b = (Ra/Rb-1)*1e3
         delta_Vap_vs_LiqA =  ( (N3_18/N3_16) / (N1_18/N1_16) - 1 ) * 1e3,
         delta_LiqB_vs_LiqA = ( (N2_18/N2_16) / (N1_18/N1_16) - 1 ) * 1e3
         )
  })
}

```

# Model solution

We calculate the dynamic solution for the initial humidity close to 0 and three values of the equilibrium fractionation factor $\delta$ (0, 50, and 100 permil):

```{r, message=FALSE}
require(deSolve)
outtimes <- seq(from = 0, to = 1, length.out = 100) # time in days
SVini <- humidityH2Oini(humidity = 1e-6)
pars1 <- pars2 <- pars
pars1["delta"] <- 50
pars2["delta"] <- 100
out0 <- ode(y = SVini, parms = pars,  func = WaterExchangeModel, times = outtimes)
out1 <- ode(y = SVini, parms = pars1, func = WaterExchangeModel, times = outtimes)
out2 <- ode(y = SVini, parms = pars2, func = WaterExchangeModel, times = outtimes)
```

We plot the number of water molecules in the model reservoirs:

```{r, fig.height=6, fig.width=8}
plot(out0, out1, out2, 
     which=c("N1",   "N2",   "N3",   "Ntot",
             "N1_16","N2_16","N3_16","Ntot_16", 
             "N1_18","N2_18","N3_18","Ntot_18"),
     xlab="time (days)", ylab="mol O2", lty=1, las=1, lwd=2, mfrow=c(3,4))
```

We plot the ${}^{18}O$ atom fractions:

```{r, fig.height=3, fig.width=8}
plot(out0, out1, out2, which=c("x1","x2","x3"),
     xlab="time (days)", las=1, lwd=2, lty=1, mfrow=c(1,3))
```

Finally, we plot the $\delta$ values:

```{r, fig.height=4, fig.width=8}
plot(out0, out1, out2, 
     which=c("delta_LiqB_vs_LiqA","delta_Vap_vs_LiqA"),
     xlab="time (days)", las=1, lwd=2, lty=1, mfrow=c(1,2))
abline(h=pars1["delta"], lty=2, col=2)
abline(h=pars2["delta"], lty=2, col=3)
legend("bottomright", title="delta (permil):",
       legend=c(sprintf("%.1f",pars["delta"]), 
                sprintf("%.1f",pars1["delta"]),
                sprintf("%.1f",pars2["delta"])), 
       lty=1, lwd=2, col=1:3, bty="n")
```