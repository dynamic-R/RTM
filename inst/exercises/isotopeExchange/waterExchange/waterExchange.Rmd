---
title: "${}^{18}$O exchange between two water reservoirs"
subtitle: "Exercises Accompanying the Course Reaction Transport Modelling in the Hydrosphere"
author: "Lubos Polerecky, Utrecht University"
date: "January 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

We consider here an experimental setup where two containers with water are enclosed in a gas-tight container filled with (partially humid) air. In the first container, the water height is $h_1$ and the area of the air-water interface is $A_1$. In the second container, the water height is $h_2$ and the area of the air-water interface is $A_2$. The volume of the gas-tight container is $V_3$ and the air pressure is $P_3$. Water molecules can be transferred between the liquid and gas phase by evaporation and precipitation. 

## Problem

Suppose that the liquid water in reservoir 1 is isotopically enriched in ${}^{18}O$. The task is to model the transfer of this isotopic enrichment from the reservoir 1 through the gas phase into the reservoir 2. All reservoirs can be assumed to be well mixed.

## Theoretical background

* Forward reaction = evaporation: rate constant $k_f$ (in $mol~m^{-2}~s^{-1}$)
* Backward reaction = precipitation: rate constant $k_b$ (in $m~s^{-1}$)

Without considering isotopes, the rate of change in the number of H$_2$O molecules in water vapor is described by the differential equation

$$ \frac{N_{vap}}{dt} = k_f\cdot A_{liq} - k_b\cdot A_{liq} \cdot \frac{N_{vap}}{V_{vap}}. $$

That is, evaporation is assumed to be a zero-order process with the rate proportional to the area of the air-water interface, and precipitation is assumed to be a first-order process with the rate proportional to the interface area and the concentration of water molecules in the gas phase ($N_{vap}/V_{vap}$).

The above formulation implies that in an equilibrium, i.e., when the time-derivative is zero, the equilibrium concentration of water molecules in the gas phase is equal to the ratio between the rate constants for the forward and backward reaction:

$$ \left( \frac{N_{vap}}{V_{vap}}\right)_{eq} = \frac{k_f}{k_b}. $$
Since $({N_{vap}}/{V_{vap}})_{eq}$ can be calculated from the Clausius-Clapeyron equation (physical chemistry), it can be considered as a known parameter. Thus, the above equation can be used to calculate $k_f$ from $k_b$.

Considering isotopes, we rewrite the above mass balance equation separately for $^{18}O$ and $^{16}O$ water molecules:

$$ 
\frac{{}^{18}N_{vap}}{dt} = {}^{18}k_f \cdot x_{liq} \cdot A_{liq} - 
{}^{18}k_b\cdot x_{vap} \cdot A_{liq} \cdot \frac{N_{vap}}{V_{vap}}, 
$$
$$ \frac{{}^{16}N_{vap}}{dt} = {}^{16}k_f \cdot (1-x_{liq}) \cdot A_{liq} - {}^{16}k_b\cdot (1-x_{vap}) \cdot A_{liq} \cdot \frac{N_{vap}}{V_{vap}}, $$
These equations consider that 

* the rate of evaporation of $^{18}O$-water is proportional to the probability that the water molecule in the liquid phase contains $^{18}O$. This probability is equal to the ${}^{18}O$ atom fraction of liquid water, which is denoted as $x_{liq}$ and calculated as $x_{liq} = {}^{18}N_{liq} / ({}^{18}N_{liq} + {}^{16}N_{liq})$.

* the rate of precipitation of $^{18}O$-water is proportional to the probability that the water molecule in the gas phase contains $^{18}O$. This probability is equal to the ${}^{18}O$ atom fraction of water vapor, which is denoted as $x_{vap}$ and calculated as $x_{vap} = {}^{18}N_{vap} / ({}^{18}N_{vap} + {}^{16}N_{vap})$.

* the rate of evaporation of $^{16}O$-water is proportional to the probability that the water molecule in the liquid phase contains $^{16}O$. This probability is equal to $1-x_{liq}$.

* the rate of precipitation of $^{16}O$-water is proportional to the probability that the water molecule in the gas phase contains $^{16}O$. This probability is equal to $1-x_{vap}$.

Now we explore how the equilibrium isotope fractionation between the water vapor and water liquid arises from the above mass balance formulation. Specifically, in an equilibrium, the time derivatives are equal to zero, which yields the following simplification of the above equations:

$$ \frac{{}^{18}N_{vap}}{dt} = 0 \quad\rightarrow\quad {}^{18}k_f \cdot x_{liq} = {}^{18}k_b\cdot x_{vap}  \cdot \frac{N_{vap}}{V_{vap}}, $$
$$ \frac{{}^{16}N_{vap}}{dt} = 0 \quad\rightarrow\quad {}^{16}k_f \cdot (1-x_{liq}) = {}^{16}k_b\cdot (1-x_{vap}) \cdot \frac{N_{vap}}{V_{vap}}. $$
By dividing the above equations with each other, we obtain
$$
\frac{{}^{18}k_f}{{}^{16}k_f}\cdot \frac{x_{liq}}{1-x_{liq}} = \frac{{}^{18}k_b}{{}^{16}k_b} \cdot \frac{x_{vap}}{1-x_{vap}},
$$
which can be simplified to 
$$
\frac{x_{liq}}{1-x_{liq}} = \alpha_{liq}(vap) \cdot \frac{x_{vap}}{1-x_{vap}}
$$
if we define the parameter $\alpha_{liq}(vap)$ according to
$$
\alpha_{liq} (vap) \equiv \left(\frac{{}^{18}k_b}{{}^{16}k_b}\right) \left/ \left(\frac{{}^{18}k_f}{{}^{16}k_f}\right)\right. .
$$

In isotope chemistry, isotope composition of a sample is typically expressed as the isotope ratio or atom fraction. When applied to water, the isotope ratio is calculated from the number of ${}^{18}O$ and ${}^{16}O$ water molecules:
$$
R = \frac{{}^{18}N}{{}^{16}N},
$$
Similarly, the atom fraction is calculated from the number of ${}^{18}O$ and total (${}^{18}O+ {}^{16}O$) water molecules:
$$
x = \frac{{}^{18}N}{{}^{18}N + {}^{16}N}.
$$
These expressions imply the following relationship between $x$ and $R$:
$$
x = \frac{R}{1+R}\quad \leftrightarrow \quad R = \frac{x}{1-x}
$$
Differences in the isotope composition of two samples are typically expressed in the $\delta$ notation. Specifically, the difference of sample *b* versus sample *a* is calculated according to 
$$
\delta_a (b) = \frac{R_b}{R_a} - 1,
$$
where $R_a$ and $R_b$ are the corresponding isotope ratios. 

We apply this definition to our specific situation and define the difference between the isotope composition of water vapor relative to liquid water according to
$$
\delta_{liq} (vap) = \frac{R_{vap}}{R_{liq}}-1.
$$

Combining the above equations, we find the following relationships, which allow calculation of $\alpha$ from $\delta$ or vice versa:
$$
\delta_{liq}(vap) = \frac{1-\alpha_{liq}(vap)}{\alpha_{liq}(vap)} \quad \leftrightarrow \quad \alpha_{liq}(vap)=\frac{1}{1+\delta_{liq}(vap)}.
$$
We emphasize that the parameter $\alpha_{liq}(vap)$ relates the rate constants of the forward and backward reactions (evaporation and precipitation) for the light and heavy water isotopes, whereas the parameter $\delta_{liq}(vap)$ relates the difference in the ${}^{18}O/{}^{16}O$ isotope ratio between water vapor and liquid in an equilibrium.


# Model definition

## Parameters describing the experimental setup

```{r}
V3    <- 1      # air volume (m3)
P     <- 101325 # air pressure (Pa)
Rgas  <- 8.314  # gas constant (SI units)
TK    <- 293.15 # temperature (K)
fH2O  <- 0.01   # molar fraction of water in air at 100% humidity
kb    <- 10     # rate constant of water precipitation (m d-1)
A1    <- 1      # area of the water reservoir 1 (m2) 
                # (corresponds to 3*4 subcores, each with inner diameter 1.2 cm)
A2    <- 1      # area of the water reservoir 2 (m2)
                # square of 25x25 cm
h1    <- 1e-3   # height of the water reservoir 1 (m)
h2    <- 1e-3   # height of the water reservoir 2 (m)
xini  <- 0.002  # natural 18O atom fraction
x1ini <- 0.002  # initial 18O atom fraction in water reservoir 1
x2ini <- 0.002  # initial 18O atom fraction in water reservoir 2
x3ini <- 0.002  # initial 18O atom fraction of water vapor (=water reservoir 3)
rho   <- 1e3    # water density (kg m-3)
MW    <- 18e-3  # molar weight of water (kg mol-1)
                # rho/MW is assumed to be the same for 16O-H2O and 18O-H2O!
```

## Derived parameters

```{r}
c3eq  <- P/(Rgas*TK) * fH2O # density of H2O molecules in air at 100% humidity (mol/m3)
V1    <- A1*h1              # volume of water in reservoir 1 (m3)
V2    <- A2*h2              # volume of water in reservoir 2 (m3)
# note: the density of particles (N/V=rho/MW) is assumed to be the same for 16O-H2O and 18O-H2O!
N1ini <- rho*V1/MW          # initial amount of H2O molecules in reservoir 1 (mol)
N2ini <- rho*V2/MW          # initial amount of H2O molecules in reservoir 2 (mol)
N3eq  <- c3eq*V3            # equilibrium amount of H2O molecules in reservoir 3 (mol)
```

## Model parameters
```{r}
pars <- c(delta = 0, # delta = steady state (R3/R1-1)*1e3, in permil!
          f1    = 1, # consider reservoir 1
          f2    = 0  # consider reservoir 2
          )
```

## Initial conditions

```{r}
# function to calculate initial state based on initial humidity of the air
humidityH2Oini <- function(humidity=1){
  # all values are in moles (16O-H2O and 18O-H2O isotopes separately)
  H2Oini <- c(N1_16 = N1ini*(1-x1ini),
              N1_18 = N1ini*x1ini,
              N2_16 = N2ini*(1-x2ini),
              N2_18 = N2ini*x2ini,
              N3_16 = N3eq*(1-x3ini) * humidity,
              N3_18 = N3eq*x3ini     * humidity
             )
  return(H2Oini)
}
```

# Model definition

```{r, eval = TRUE, cache = FALSE, echo = TRUE, warning=FALSE, message=FALSE}
WaterExchangeModel <-function(t, state, pars) {
  # t: time, state: state variables, pars: model parameters
  with (as.list(c(state, pars)),{
    
    # convert delta (in permil!) to alpha = kb_18/kb_16
    alpha <- 1/(delta*1e-3 + 1)
    
    # calculate all rate constants based on the rate constant 
    # of water precipitation (kb), the fractionation factor (alpha), 
    # and the equilibrium concentration c3eq
    kb_16 <- kb
    kb_18 <- kb * alpha
    kf_16 <- kb * c3eq
    kf_18 <- kb * c3eq
          
    # current amounts of H2O molecules in all reservoirs
    N1 <- N1_16+N1_18 
    N2 <- N2_16+N2_18 
    N3 <- N3_16+N3_18
    # current 18O atom fractions in all reservoirs
    x1 <- N1_18/N1 
    x2 <- N2_18/N2
    x3 <- N3_18/N3
    
    # rate expressions [mol/d]
    
    # exchange between reservoir 1 (water) and 3 (water vapour)
    Evap1_16 <- kf_16 * (1-x1) * A1 * (N1>0)
    Evap1_18 <- kf_18 *    x1  * A1 * (N1>0)
    Cond1_16 <- kb_16 * (1-x3) * A1 * N3/V3
    Cond1_18 <- kb_18 *    x3  * A1 * N3/V3
    
    # exchange between reservoir 2 (water) and 3 (water vapour)
    Evap2_16 <- kf_16 * (1-x2) * A2 * (N2>0)
    Evap2_18 <- kf_18 *    x2  * A2 * (N2>0)
    Cond2_16 <- kb_16 * (1-x3) * A2 * N3/V3
    Cond2_18 <- kb_18 *    x3  * A2 * N3/V3
    
    # Time-derivatives: dN/dt = production - consumption [mol/d]
    dN1_16.dt <- (-Evap1_16 + Cond1_16)*f1
    dN1_18.dt <- (-Evap1_18 + Cond1_18)*f1
    dN2_16.dt <- (-Evap2_16 + Cond2_16)*f2
    dN2_18.dt <- (-Evap2_18 + Cond2_18)*f2
    dN3_16.dt <- ( Evap1_16 - Cond1_16)*f1 + (Evap2_16 - Cond2_16)*f2
    dN3_18.dt <- ( Evap1_18 - Cond1_18)*f1 + (Evap2_18 - Cond2_18)*f2
    
    # return time-derivatives and ordinary variables as a list
    list(c(dN1_16.dt, dN1_18.dt,
           dN2_16.dt, dN2_18.dt,
           dN3_16.dt, dN3_18.dt),
         
         # number of molecules
         Ntot_16 = N1_16+N2_16+N3_16, # total 16O-water
         Ntot_18 = N1_18+N2_18+N3_18, # total 18O-water
         N1 = N1_16 + N1_18,          # total water molecules, liquid 1
         N2 = N2_16 + N2_18,          # total water molecules, liquid 2
         N3 = N3_16 + N3_18,          # total water molecules, vapor
         Ntot = N1_16+N2_16+N3_16+N1_18+N2_18+N3_18, # all water molecules
         
         # 18O atom fractions
         x1 = N1_18/(N1_16+N1_18),
         x2 = N2_18/(N2_16+N2_18),
         x3 = N3_18/(N3_16+N3_18),
         
         # delta values (permil): delta_a_vs_b = (Ra/Rb-1)*1e3
         delta_Vap_vs_LiqA =  ( (N3_18/N3_16) / (N1_18/N1_16) - 1 ) * 1e3,
         delta_LiqB_vs_LiqA = ( (N2_18/N2_16) / (N1_18/N1_16) - 1 ) * 1e3
         )
  })
}

```

# Model solution

We calculate the dynamic solution for the initial humidity close to 0 and three values of the equilibrium fractionation factor $\delta$ (0, 50, and 100 permil):

```{r, message=FALSE}
require(deSolve)
outtimes <- seq(from = 0, to = 1, length.out = 100) # time in days
SVini <- humidityH2Oini(humidity = 1e-6)
pars1 <- pars2 <- pars
pars1["delta"] <- 50
pars2["delta"] <- 100
out0 <- ode(y = SVini, parms = pars,  func = WaterExchangeModel, times = outtimes)
out1 <- ode(y = SVini, parms = pars1, func = WaterExchangeModel, times = outtimes)
out2 <- ode(y = SVini, parms = pars2, func = WaterExchangeModel, times = outtimes)
```

We plot the number of water molecules in the model reservoirs:

```{r, fig.height=6, fig.width=8}
plot(out0, out1, out2, 
     which=c("N1",   "N2",   "N3",   "Ntot",
             "N1_16","N2_16","N3_16","Ntot_16", 
             "N1_18","N2_18","N3_18","Ntot_18"),
     xlab="time (days)", ylab="mol O2", lty=1, las=1, lwd=2, mfrow=c(3,4))
```

We plot the ${}^{18}O$ atom fractions:

```{r, fig.height=3, fig.width=8}
plot(out0, out1, out2, which=c("x1","x2","x3"),
     xlab="time (days)", las=1, lwd=2, lty=1, mfrow=c(1,3))
```

Finally, we plot the $\delta$ values:

```{r, fig.height=4, fig.width=8}
plot(out0, out1, out2, 
     which=c("delta_LiqB_vs_LiqA","delta_Vap_vs_LiqA"),
     xlab="time (days)", las=1, lwd=2, lty=1, mfrow=c(1,2))
abline(h=pars1["delta"], lty=2, col=2)
abline(h=pars2["delta"], lty=2, col=3)
legend("bottomright", title="delta (permil):",
       legend=c(sprintf("%.1f",pars["delta"]), 
                sprintf("%.1f",pars1["delta"]),
                sprintf("%.1f",pars2["delta"])), 
       lty=1, lwd=2, col=1:3, bty="n")
```